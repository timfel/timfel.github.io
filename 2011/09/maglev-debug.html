<!DOCTYPE html>
<html lang='en'>
  <!-- Hello dear source reader, feel free to wander around. -->
  <head>
    <!-- I *love* UTF-8 -->
    <meta charset='utf-8' />
    <title>Debugging on steroids - what Ruby should learn from Smalltalk - blog.bithug.org</title>
    <script src='/articles.js?YjBmOTgzYg==' type='text/javascript'></script>
    <script src='/blog.js?YjBmOTgzYg==' type='text/javascript'></script>
    <link href='/blog.css?YjBmOTgzYg==' rel='stylesheet' type='text/css' />
    <link href='http://feeds.feedburner.com/blogbithugorg' rel='alternate' title='blog.bithug.org' type='application/rss+xml' />
  </head>
  <body class='hyphenate'>
    <!-- IE 9 supports CSS3/HTML5, or at least that's what I'm told. -->
    <!--[if lt IE 9]>
      <script src='http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js' type='text/javascript'></script>
      <div id='prompt'></div>
      <script type='text/javascript'>
        //<![CDATA[
          window.attachEvent("onload", function() { CFInstall.check({ mode: "inline", node: "prompt" })});
        //]]>
      </script>
    <![endif]-->
    <div class='blog'>
      <article data-source='/2011/09/maglev-debug.html'>
        <div class='header'>
          Coding and stuff
          <div class='subtitle'>Because, because, because of the wonderful things he does</div>
        </div>
        <nav>
          <a class='link first' href='/2010/06/jax.html' title='Git talk @ JaX 2010'>&lt;&lt;</a>
          <a class='link prev' href='/2010/11/powersaving-on-macbook.html' title='Linux PM on Macbook Pro'>&lt;</a>
          <a class='link next' href='/2012/02/cloud-foundry-squeak.html' title='CloudFoundry for Smalltalk appl&hellip;'>&gt;</a>
          <a class='link last' href='/2012/08/qoppa.html' title='Qoppa - a language to learn abo&hellip;'>&gt;&gt;</a>
        </nav>
        <aside>
          <p>
            <a href='http://feeds.feedburner.com/blogbithugorg' rel='alternate' title='Subscribe to my feed' type='application/rss+xml'>
              <img alt='Subscribe to my feed' src='/images/feed-icon.png' />
            </a>
          </p>
          <div>About me</div>
          <img src='http://www.gravatar.com/avatar/36fee2e65c9c0ed678fe3b7d862ed271?s=80' />
          <p>This blog was started to track my progress on my RubySoc 2010 project, Ruby C extension support for JRuby. It is now used for other things, too. Expect mostly Ruby topics.</p>
          
          <p>I&#8217;m studying for a master&#8217;s degree at <a href='http://www.hpi.uni-potsdam.de/'>Hasso Plattner Institute</a>, <a href='http://www.uni-potsdam.de/'>University Of Potsdam</a>, I&#8217;m mainly at the <a href='http://www.hpi.uni-potsdam.de/hirschfeld/'>Software Architecture Group</a>. Once a week I also work as a software engineer at <a href='http://www.finn.de/'>Finnlabs</a>.</p>
          
          <p>If you want to know what technical topics I&#8217;m working on, follow me on <a href='http://twitter.com/timfelgentreff'>Twitter</a>. Most of the code I&#8217;m talking about is on <a href='http://github.com/timfel'>GitHub</a>, which is the central hub for my contributions to varous FOSS projects. I am also increasingly working on <a href='/research.html'>research</a> related stuff. I sometimes give <a href='/presentations.html'>presentations</a>.</p>
          <h3>Posts</h3>
          <article>
            <div class='date'>2012/08/27</div>
            <a href='/2012/08/qoppa.html'>Qoppa - a language to learn about Fexpr's</a>
          </article>
          <article>
            <div class='date'>2012/05/31</div>
            <a href='/2012/05/thesis.html'>Master Thesis Progress</a>
          </article>
          <article>
            <div class='date'>2012/02/22</div>
            <a href='/2012/02/cloud-foundry-squeak.html'>CloudFoundry for Smalltalk applications</a>
          </article>
          <article>
            <div class='date'>2011/09/08</div>
            <a href='/2011/09/maglev-debug.html'>Debugging on steroids - what Ruby should learn from Smalltalk</a>
          </article>
          <article>
            <div class='date'>2010/11/28</div>
            <a href='/2010/11/powersaving-on-macbook.html'>Linux PM on Macbook Pro</a>
          </article>
          <article>
            <div class='date'>2010/11/10</div>
            <a href='/2010/11/rsoc.html'>Ruby Summer of Code Wrap-Up</a>
          </article>
          <article>
            <div class='date'>2010/10/23</div>
            <a href='/2010/10/redcar-syntax-checks.html'>Syntax Checking For Redcar</a>
          </article>
          <article>
            <div class='date'>2010/09/26</div>
            <a href='/2010/09/redcar-debug.html'>A Redcar debugger interface</a>
          </article>
          <article>
            <div class='date'>2010/08/14</div>
            <a href='/2010/08/benchmarking-rdiscount.html'>Benchmarking RDiscount</a>
          </article>
          <article>
            <div class='date'>2010/07/13</div>
            <a href='/2010/07/thin-on-jruby.html'>Thin on JRuby</a>
          </article>
          <article>
            <div class='date'>2010/07/09</div>
            <a href='/2010/07/capi-the-thin-gem-and-not-much-to-show.html'>JRuby commit flag</a>
          </article>
          <article>
            <div class='date'>2010/06/18</div>
            <a href='/2010/06/first-week-of-rubysoc.html'>First week of RubySOC</a>
          </article>
          <article>
            <div class='date'>2010/06/07</div>
            <a href='/2010/06/jax.html'>Git talk @ JaX 2010</a>
          </article>
        </aside>
        <header>
          <h1 property='dc:title' xmlns:dc='http://purl.org/dc/elements/1.1/'>Debugging on steroids - what Ruby should learn from Smalltalk</h1>
          <div class='author'>
            by
            <a href='mailto:timfelgentreff@gmail.com' property='cc:attributionName' xmlns:cc='http://creativecommons.org/ns#'>Tim Felgentreff</a>
            ,
            <time class='timeago' datetime='2011-09-08T00:00:00+02:00' pubdate='pubdate'>2011/09/08, 00:00 CEST</time>
          </div>
        </header>
        <section class='content'>
          <h2 id='a_prototype_of_seasidelike_debugging_in_ruby'>A prototype of Seaside-like debugging in Ruby</h2>
          
          <h3 id='the_premise'>The premise</h3>
          
          <p>I have used Smalltalk and the <a href='http://seaside.st'>Seaside</a> web-framework for some time before <a href='http://rkh.im'>Konstantin</a> introduced me to Ruby. I&#8217;ve come to use Ruby for most of my scripting needs, but what I&#8217;ve always preferred about Smalltalk is the tool integration: because you&#8217;re working with a live system, you have access to all these objects you write code for, to play with and see how they behave whenever you want to.</p>
          
          <p>So in Seaside, when you break your application, you get a stacktrace page not unlike the pages in Rails, Sinatra, or Rack. However, in addition to the links for framework and full traces, you have a link to <em>debug</em> the thing directly. Simply at the point where it has thrown the error. And then resume it. As if nothing ever happened.</p>
          
          <p>In Rails, when you break your application, you try to figure out what&#8217;s wrong from the trace and by looking at the code. Then you change the code and hope the Rails reloader works (and that you cannot always rely on, see Konstantin&#8217;s <a href='http://rkh.im/code-reloading'>post</a> on the matter). In Sinatra or Rack apps, you&#8217;ll usually have to restart your app. This means waiting for the server to come up and the request to be handled again. Even if it&#8217;s just a second or two &#8230; it does add up.</p>
          
          <p>Also, it&#8217;s bloody annoying.</p>
          
          <h3 id='here_comes_everybody'>Here comes Everybody&#8230;</h3>
          
          <p>&#8217;s favorite Ruby implementation <a href='http://ruby.gemstone.com'>MagLev</a>! MagLev is a Ruby implementation build on the excellent, mature, and battle-tested Gemstone/S Smalltalk product. Ruby classes and methods on MagLev are almost indistinguishable from Smalltalk methods and classes, and most of the core classes are simply shared between the implementations.</p>
          
          <p>Since I&#8217;ve recently started an internship with Gemstone (now owned by VMware) in Beaverton, OR, I have the opportunity to try and provide a bridge for some of that Smalltalk goodness to reach the Ruby world!</p>
          
          <p>First thing I added enough reflection to the Ruby core classes (mostly Thread and Method) to allow writing a debugger in pure Ruby.</p>
          
          <ul>
          <li>This means being able to inspect, change, step through, and restart frames.</li>
          
          <li>This means stopping, copying, saving, and restarting Threads, all in pure Ruby.</li>
          
          <li>This also means having an API to change methods and classes, in-process, and have them write back to the file-system to keep it consistent with the process&#8217; contents.</li>
          </ul>
          
          <h3 id='later_that_same_day'>Later, that same day</h3>
          
          <p>Being well equipped with <strong>Awesome Reflective Powers</strong>&#8482; now, I wrote an error handling Rack middleware for inclusion in any Rails, Rack and Sinatra app, and whipped up a very simple, web-based debugger that can connect to a running process and, well, debug it.</p>
          
          <p>I presented the demo in the video below at the <a href='http://pdxruby.org'>pdx.rb</a> meeting in September. So what&#8217;s going on here? First, I&#8217;m using an old Sinatra app which I&#8217;ve added a bug to. This bug triggers the Rack middleware to save a continuation of the thread and present a (very, very simple) error page explaining what you can do from there. That page has a link to resume the thread that handled the connection. If you click it, without actually debugging, the thread just continues and shows the Sinatra error page as it would without the middleware.</p>
          
          <p>We, however, having installed MagLev&#8217;s <a href='http://www.github.com/MagLev/webtools'>Webtools</a>, can connect to the other process, find the right thread and look at the stack. We can quickly find the last frame that executes some of our code: the class method <strong>Bithug::User.find</strong>.</p>
          
          <p>Because we&#8217;re dealing with an actual, living and breathing thread object saved to the stone repository, we can send messages to it to look at the arguments and locals of a method. We can see that <em>self</em> is the Bithug::User class, and that the <em>Db</em> constant that was involved in the error is a <em>KeyValueDictionary</em>. We can also find out that the value the method selects from the Db is non-existent. After noticing our mistake (<em>self.class.name</em> should really be <em>self.name</em>, because we&#8217;re already on the class side) we can edit the code and save it, thereby</p>
          
          <ul>
          <li>changing the code in process,</li>
          
          <li>writing it back to the file system,</li>
          
          <li>and instructing the thread to reload and re-execute that frame</li>
          </ul>
          
          <p>The thread is still suspended and in a persistent state. But if we go back to our application now and tell it to resume the request, it will prepare the thread for execution and run it - and we can see our app load. The error is fixed!</p>
          <pre class='markdown-html-error' style='border: solid 3px red; background-color: pink'>REXML could not parse this XML/HTML: 
          &lt;iframe width=&quot;425&quot; height=&quot;349&quot;
          	src=&quot;http://www.youtube.com/embed/LvipqMIHkO8?hl=en&amp;fs=1&quot;
          	frameborder=&quot;0&quot; allowfullscreen&gt;
          &lt;/iframe&gt;</pre>
          <h3 id='why_this_is_cool'>Why this is cool</h3>
          
          <p>Just using plain old Ruby, we can debug an application, we can inspect and change it <em>while it is running</em>. We don&#8217;t have to restart the process, we don&#8217;t even have to restart the request, it&#8217;s all in the thread, persisted to the repository.</p>
          
          <p>The actual application doesn&#8217;t need to expose all these things, either. The thread was saved to the stone repository anyway, we can fire up a VM on a completely different machine, pull the thread from the stone and debug there! So even production, no error will ever need to go undebugged, because <em>you can keep every error around for later inspection</em>! No more trying to reproduce what&#8217;s on your production system - triggering the error just once is enough to step through it again and again and again and again.</p>
          
          <p>This is one of the many advantages of having a malleable Smalltalk stack and real object persistence built into your VM!</p>
          
          <p>Other use-cases come to mind. Remember, all this is accessible using pure Ruby.</p>
          
          <p>You might want to handle other extraordinary cases in your application by simply persisting a continuation of the interesting state, so you can look at it later.</p>
          
          <p>Or whenever you look at a method wondering what&#8217;s going on, you can just pull up a thread <em>from your life app</em> and see what kinds of arguments you might get, and what the state of your application might look like in this method.</p>
          
          <h2 id='soon_at_a_ruby_implementation_near_you'>Soon, at a Ruby implementation near you</h2>
          
          <p>I am currently working on providing and documenting enough API for people to do all these things with their Ruby apps. I hope some of this will show Rubyists that having an extraordinarily dynamic language doesn&#8217;t mean you can&#8217;t have great tools as well&#8230;</p>
        </section>
        <br />
        <section class='license'>
          <a rel="cc:attributionURL" href="http://github.com/rkh/rkh.im">This work</a> is licensed under a
          <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/de/deed.en">Creative Commons
          Attribution-ShareAlike 3.0 Germany License</a>. Any source code included is, unless stated otherwise,
          licensed under a <a rel="licenses" href="http://creativecommons.org/licenses/MIT/">MIT License</a>.
          <span class='noprint'>This does not apply for comments (below).</span>
        </section>
        <section class='comments'>
          <!-- I both love and hate disqus -->
        </section>
      </article>
    </div>
  </body>
</html>
